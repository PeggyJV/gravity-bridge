version: '3'

services:
  ethereum:
    build:
      context: .
      dockerfile: ./ethereum/Dockerfile
    ports:
      - "8545:8545"

  contract_deployer:
    build:
      context: ./solidity
      dockerfile: ./Dockerfile
    depends_on:
      - ethereum
      - gravity0

  gravity0:
    build:
      context: ./module
      dockerfile: ./Dockerfile
    depends_on:
      - ethereum
    ports:
      - "26656:26656"
      - "26657:26657"
      - "1317:1317"
      - "9090:9090"
      - "6060-6065:6060-6065"
    volumes:
      - ./testdata/testchain/gravity0:/root/home

  orchestrator0:
    build:
      context: ./orchestrator
      dockerfile: ./Dockerfile
    depends_on:
      - ethereum
    environment:
      - CONTRACT_ADDR
      - COSMOS_KEY
      - COSMOS_PHRASE
      - DENOM
      - ETH_PRIVATE_KEY
      - RUST_BACKTRACE=1
      - RUST_LOG
      - VALIDATOR

  gravity1:
    build:
      context: ./module
      dockerfile: ./Dockerfile
    volumes:
      - ./testdata/testchain/gravity1:/root/home
    depends_on:
      - ethereum

  orchestrator1:
    build:
      context: ./orchestrator
      dockerfile: ./Dockerfile
    depends_on:
      - ethereum
    environment:
      - CONTRACT_ADDR
      - COSMOS_KEY
      - COSMOS_PHRASE
      - DENOM
      - ETH_PRIVATE_KEY
      - VALIDATOR

  gravity2:
    build:
      context: ./module
      dockerfile: ./Dockerfile
    volumes:
      - ./testdata/testchain/gravity2:/root/home
    depends_on:
      - ethereum

  orchestrator2:
    build:
      context: ./orchestrator
      dockerfile: ./Dockerfile
    depends_on:
      - ethereum
    environment:
      - CONTRACT_ADDR
      - COSMOS_KEY
      - COSMOS_PHRASE
      - DENOM
      - ETH_PRIVATE_KEY
      - VALIDATOR

  gravity3:
    build:
      context: ./module
      dockerfile: ./Dockerfile
    volumes:
      - ./testdata/testchain/gravity3:/root/home
    depends_on:
      - ethereum

  orchestrator3:
    build:
      context: ./orchestrator
      dockerfile: ./Dockerfile
    depends_on:
      - ethereum
    environment:
      - CONTRACT_ADDR
      - COSMOS_KEY
      - COSMOS_PHRASE
      - DENOM
      - ETH_PRIVATE_KEY
      - VALIDATOR

  test_runner:
    build:
      context: ./orchestrator
      dockerfile: testnet.Dockerfile
    depends_on:
      - ethereum
    volumes:
      - ./testdata:/testdata
    environment:
      - RUST_BACKTRACE=1
      - RUST_LOG
      - TEST_TYPE